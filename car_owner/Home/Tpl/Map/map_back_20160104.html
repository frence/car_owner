<!DOCTYPE html>
<html style="width:100%; height:100%;">
<head>
<!-- <script src="https://code.jquery.com/jquery-1.9.1.js"></script> -->
<script src="{$Think.const.JS_URL}jquery-1.7.1.min.js"></script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no" />
<meta name="MobileOptimized" content="320" />
<style type="text/css">
html,body{
    width:100%;
    height:100%;
    overflow:hidden;
}
*{
    margin:0px;
    padding:0px;
}
</style>
<title>洗车场</title>
<script charset="utf-8" src="http://map.qq.com/api/js?v=2.exp&key=IFEBZ-MF5HU-IXOVH-2JWRJ-JCKCK-CAFO5&libraries=drawing,geometry,autocomplete,convertor"></script>
<link type="text/css" rel="stylesheet" href="{$Think.const.CSS_URL}style.css" />
<script type="text/javascript" src="{$Think.const.JS_URL}common/language.js" ></script>
<script>

var lat = null;
var lng = null;
var latlngs=[];

//定位自身坐标
function getLocation(){
  if (navigator.geolocation){

      navigator.geolocation.getCurrentPosition(showPosition);
    }else{
      x.innerHTML="浏览器不支持定位.";
    }
  }

function showPosition(position)
  {
    //定位地图中心点
     lat=position.coords.latitude; 
     lng=position.coords.longitude;

     $.post('index.php?m=Map&a=index',{"lat":lat,"lng":lng},function (msg){ 




      //若无相关数据、显示无数据提示
      if(msg.indexOf("附近暂无洗车场!")>=0){
         //原有中心坐标
         latlngs=[new qq.maps.LatLng(lat,lng)];

      }else{
        var data =JSON.parse(msg); 

        //开始创建多标注
        qq.maps.convertor.translate(

        //创建地图
        new qq.maps.LatLng(lat,lng), 1, function(res){

        latlng = res[0];
        lat = res[0].lat;
        lng = res[0].lng;

        //创建地图对象
        var map = new qq.maps.Map(document.getElementById("container"),{
              center:  latlng,
              zoom: 14
          });

        //标记自身所在的位置
        var anchor = new qq.maps.Point(6, 6),
        size = new qq.maps.Size(36, 36),
        origin = new qq.maps.Point(0, 0),
        icon = new qq.maps.MarkerImage('{$Think.const.IMG_URL}icon.gif', size, origin, anchor);

        var marker = new qq.maps.Marker({
        icon: icon,
        map: map,
        position:map.getCenter()});



        var infoWin = new qq.maps.InfoWindow({
            map: map
        });

        //循环为每个坐标创建Marker，创建的Marker放入markers数组,并监听事件
        for(var i = 0;i < data.length; i++) {
            (function(){
                var ParkX = data[i].ParkX;
                var ParkY = data[i].ParkY;
                var LatLng = new qq.maps.LatLng(ParkX,ParkY);
                var ParkName = data[i].ParkName;
                var ParkAddress = data[i].ParkAddress;
                var priceself = data[i].price_self;
                var pricehelp = data[i].price_help;
                var ServiceType = data[i].ServiceType;
                var WasherNum = data[i].WasherNum;
                var ParkId = data[i].ParkId;
                var ParkImage = data[i].ParkImage;

                //定义地图图片
                var anchor = new qq.maps.Point(36, 36),
                size = new qq.maps.Size(280, 150),
                origin = new qq.maps.Point(0, 0),
                // icon = new qq.maps.MarkerImage('index.php?m=Map&a=createimgtext&ParkName='+ParkName, size, origin, anchor);
                 icon = new qq.maps.MarkerImage('{$Think.const.ADIMG_URL}'+ParkImage, size, origin, anchor);


                var marker = new qq.maps.Marker({
                    icon: icon,
                    position: LatLng,
                    map: map
                });  

                qq.maps.event.addListener(marker, 'click', function() {
                    infoWin.open();
                    infoWin.setContent( ' <div class="text">'
                                      +'    <p>'+ParkName+'</p>'
                                      +'    <p>地址:'+ParkAddress+'</p>'
                                      +'    <p>自助洗价格<span>'+priceself+'元</span>/次</p>'
                                      +'  </div>'
                                      +' <div class="input">'
                                      +' <button class="b1" onclick="search(this)" '
                                      +' parkx="'+ParkX+'"  parky="'+ParkY+'">导航</button>'
                                      +' <button class="b2" onclick="attention(this)"'
                                      +' ParkId="'+ParkId+'">关注</button>'
                                      +' <button class="b2" onclick="cardetails(this)"'
                                      +' ParkId="'+ParkId+'">详情</button>'
                                      +' </div>');
                    infoWin.setPosition(LatLng);
                });
            })(i);
        }
        });

       }
    });

  }


  function search(obj){
    var ParkX =$(obj).attr("parkx");
    var ParkY =$(obj).attr("parky");

    location.href="index.php?m=Map&a=position&ParkX="+ParkX+"&ParkY="+ParkY+"&lat="+lat+"&lng="+lng;
  }

  function attention(obj){
    var ParkId = $(obj).attr("ParkId");
    // alert(ParkId);
    $.post('index.php?m=Map&a=attention',{"ParkId":ParkId},function (msg){
      if(msg ==1){
        showmodel(prompt_map_success);
        return;
      }else if(msg ==0){
        showmodel(prompt_map_error);
        return;
      }else if(msg ==2){
        showmodel(prompt_map_attention);
        return;
      }else{
        showmodel(prompt_map_openid);
        return;
      }
    });
      

  }

  function cardetails(obj){
    var ParkId = $(obj).attr("ParkId");
    location.href="index.php?m=Map&a=cardetails&ParkId="+ParkId;
  }

    //关闭弹出层
    function closemodel(){
        $(".nb_wrap,.nb").hide(); 
        $("#"+mouse_add).focus();
        
    }
    //弹出弹出层
    function showmodel(str){
        $(".nb_wrap,.nb_1").html(str);
        $(".nb_wrap,.nb").show(); 
    }




</script>
</head>
  <body onload="getLocation()" style="width:100%; height:100%;">
    <div class="outer" style="width:100%;height:100%;" id="container">
    	<!-- <div class="inner" id="container"></div> -->
     
      <div style="width:100%;height:100%;" id="container"></div>
    </div>
    <div style='width:100%; height:100%;' id="infoDiv">
       <div class="nb_wrap"></div>
        <div class="nb" onclick="closemodel()">
            <div class="nb_1"></div>
            <div class="nb_2">
                <span>
                <a href="javascript:void(0);" >确定</a>
                </span>
            </div>
        </div>
    </div>
    <div class="db_li" style="width:100%;position:fixed;bottom:0px;border:1px solid #ccc;">
    	<ul>
          <volist name="list" id="v1">
        	<li><button onclick="search(this)" parkx="{$v1['ParkX']}" parky="{$v1['ParkY']}">导航</button>
            <span>{$v1['ParkName']}</span>
          </li>
<!--             <li><button>导航</button><span>福大旗舰点</span></li>
            <li><button>导航</button><span>福清旗舰点</span></li>
            <li><button>导航</button><span>莆田旗舰点</span></li> -->
          </volist>
      </ul>
    </div>
  </body>
</html>